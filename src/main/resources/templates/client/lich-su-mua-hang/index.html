<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/client/layout/layout-client.html"
>
<head>
    <th:block layout:fragment="head_link">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
              integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
              crossorigin="anonymous" referrerpolicy="no-referrer"/>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
              integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
              crossorigin="anonymous">
        <style>
            .status-badge {
                padding: 5px 10px;
                border-radius: 15px;
                font-size: 0.85rem;
                font-weight: 500;
            }
            .status-waiting {
                background-color: #ffe6cc;
                color: #cc7a00;
            }
            .status-confirmed {
                background-color: #d1e7ff;
                color: #0066cc;
            }
            .status-delivering {
                background-color: #d1ecf1;
                color: #0c5460;
            }
            .status-completed {
                background-color: #d4edda;
                color: #155724;
            }
            .status-cancelled {
                background-color: #f8d7da;
                color: #721c24;
            }
            .order-card {
                margin-bottom: 15px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }
            .timeline .card {
                border-left: 3px solid #007bff;
            }
            /* CSS cho tiêu đề Lịch sử mua hàng */
            .order-history-header {
                position: relative;
                padding-bottom: 10px;
            }

            .order-history-header h2 {
                font-size: 28px;
                margin-bottom: 5px;
                color: #3a86ff;
                display: inline-block;
            }

            .title-underline {
                height: 3px;
                width: 80px;
                background: linear-gradient(90deg, #3a86ff, #8338ec);
                border-radius: 3px;
                margin-top: 5px;
            }

            /* CSS nâng cao cho các tab */
            .nav-tabs .nav-link {
                font-weight: 500;
                color: #6c757d;
                border-bottom: 2px solid transparent;
                transition: all 0.3s ease;
            }

            .nav-tabs .nav-link.active {
                color: #3a86ff;
                border-bottom: 2px solid #3a86ff;
                background-color: transparent;
            }

            .nav-tabs .nav-link:hover:not(.active) {
                border-color: #e9ecef #e9ecef #dee2e6;
                color: #495057;
            }
            /* Thêm CSS cho phân trang */
            .pagination {
                display: flex;
                justify-content: center;
                margin-top: 20px;
            }

            .pagination li {
                list-style-type: none;
                margin: 0 5px;
            }

            .pagination li a {
                color: #333;
                text-decoration: none;
                padding: 8px 12px;
                border: 1px solid #ddd;
                border-radius: 4px;
                transition: background-color 0.3s;
            }

            .pagination li.active a {
                background-color: #007bff;
                color: white;
                border-color: #007bff;
            }

            .pagination li a:hover:not(.active) {
                background-color: #f5f5f5;
            }

            .pagination li.disabled a {
                color: #ccc;
                cursor: not-allowed;
            }
            /* Làm đậm hơn tab đang được chọn */
            .nav-tabs .nav-link.active {
                font-weight: bold;
                color: #0d6efd; /* Màu xanh chính của Bootstrap */
                border-bottom: 2px solid #0d6efd; /* Thêm đường gạch chân đậm hơn */
            }

            /* Tuỳ chọn: Thêm hiệu ứng hover cho tab */
            .nav-tabs .nav-link:hover:not(.active) {
                border-bottom: 1px solid #0d6efd;
                color: #0d6efd;
                opacity: 0.8;
            }
        </style>

    </th:block>
</head>
<body>
<div layout:fragment="content">
    <div class="container mt-4">
        <div class="order-history-header mb-4">
            <h2 class="text-primary fw-bold">
                <i class="fas fa-shopping-bag me-2"></i>Lịch sử mua hàng
            </h2>
            <div class="title-underline"></div>
        </div>
        <!-- Tabs trạng thái -->
        <!-- Tabs trạng thái -->
        <!-- Tabs trạng thái -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link" th:classappend="${trangThai == null} ? 'active'" th:href="@{/lichsumuahang}">Tất cả</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${trangThai == 'CHO_XAC_NHAN'} ? 'active'" th:href="@{/lichsumuahang/trangthai/CHO_XAC_NHAN}">Chờ xác nhận</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${trangThai == 'XAC_NHAN,DANG_CHUAN_BI_HANG'} ? 'active'" th:href="@{/lichsumuahang/trangthai/{status}(status='XAC_NHAN' + ',' + 'DANG_CHUAN_BI_HANG')}">Chờ đóng gói</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${trangThai == 'CHO_LAY_HANG'} ? 'active'" th:href="@{/lichsumuahang/trangthai/CHO_LAY_HANG}">Chờ giao hàng</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${trangThai == 'LAY_HANG_THANH_CONG,DANG_VAN_CHUYEN,DANG_GIAO'} ? 'active'" th:href="@{/lichsumuahang/trangthai/{status}(status='LAY_HANG_THANH_CONG' + ',' + 'DANG_VAN_CHUYEN' + ',' + 'DANG_GIAO')}">Đang giao hàng</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${trangThai == 'GIAO_HANG_THANH_CONG,THANH_CONG'} ? 'active'" th:href="@{/lichsumuahang/trangthai/{status}(status='GIAO_HANG_THANH_CONG' + ',' + 'THANH_CONG')}">Hoàn tất</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" th:classappend="${trangThai == 'DA_HUY'} ? 'active'" th:href="@{/lichsumuahang/trangthai/DA_HUY}">Đã hủy</a>
            </li>
        </ul>
        <!-- Danh sách đơn hàng -->
        <div th:if="${hoaDons.isEmpty()}" class="alert alert-info">
            Không có đơn hàng nào.
        </div>
        <div th:if="${!hoaDons.isEmpty()}" class="row">
            <div class="col-12" th:each="hoaDon : ${hoaDons}">
                <div class="card order-card mb-3">
                    <div class="order-header d-flex justify-content-between align-items-center p-3 bg-light">
                        <div>
                            <h5 class="mb-0">Đơn hàng #<span th:text="${hoaDon.id}"></span></h5>
                            <span class="text-muted" th:text="${#temporals.format(hoaDon.getNgayDatFromLichSu(), 'dd/MM/yyyy')}"></span>
                        </div>
                        <div>
                         <span class="status-badge"  th:classappend="${
                                  hoaDon.trangThai == 'Chờ xác nhận' ? 'status-waiting' : (
                                  hoaDon.trangThai == 'Chờ đóng gói' || hoaDon.trangThai == 'Chờ giao hàng' ? 'status-confirmed' : (
                                  hoaDon.trangThai == 'Đang giao hàng' ? 'status-delivering' : (
                                  hoaDon.trangThai == 'Đã nhận hàng' || hoaDon.trangThai == 'Hoàn tất' ? 'status-completed' :
                                  'status-cancelled')))}"
                               th:text="${hoaDon.trangThai}">
                         </span>
                        </div>
                    </div>
                    <div class="order-body p-3">
                        <div class="row">
                            <div class="col-md-8">
                                <p><strong>Người nhận:</strong> <span th:text="${hoaDon.tenNguoiNhan}"></span></p>
                                <p><strong>Số điện thoại:</strong> <span th:text="${hoaDon.soDienThoai}"></span></p>
                                <p><strong>Địa chỉ:</strong> <span th:text="${hoaDon.diaChi}"></span></p>
                            </div>
                            <div class="col-md-4 text-md-end">
                                <p><strong>Tổng tiền:</strong> <span th:text="${#numbers.formatDecimal(hoaDon.tongTien, 0, 'COMMA', 0, 'POINT')} + ' VND'"></span></p>
                                <p><strong>Phương thức:</strong> <span th:text="${hoaDon.phuongThucThanhToan}"></span></p>
                                <button class="btn btn-primary btn-view-details" th:data-id="${hoaDon.id}">Xem chi tiết</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phân trang -->
        <div th:if="${totalPages > 1}" class="d-flex justify-content-center mt-4" style="margin-bottom: 20px">
            <nav aria-label="Phân trang">
                <ul class="pagination">
                    <!-- Nút Previous -->
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" th:if="${trangThai == null && khachHangId == null}"
                           th:href="@{/lichsumuahang(page=${currentPage - 1})}">&laquo;</a>
                        <a class="page-link" th:if="${trangThai != null}"
                           th:href="@{'/lichsumuahang/trangthai/' + ${trangThai}(page=${currentPage - 1})}">&laquo;</a>
                        <a class="page-link" th:if="${khachHangId != null}"
                           th:href="@{'/lichsumuahang/khachhang/' + ${khachHangId}(page=${currentPage - 1})}">&laquo;</a>
                    </li>

                    <!-- Các nút số trang -->
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                        th:classappend="${currentPage == i} ? 'active'">
                        <a class="page-link" th:if="${trangThai == null && khachHangId == null}"
                           th:href="@{/lichsumuahang(page=${i})}" th:text="${i + 1}"></a>
                        <a class="page-link" th:if="${trangThai != null}"
                           th:href="@{'/lichsumuahang/trangthai/' + ${trangThai}(page=${i})}" th:text="${i + 1}"></a>
                        <a class="page-link" th:if="${khachHangId != null}"
                           th:href="@{'/lichsumuahang/khachhang/' + ${khachHangId}(page=${i})}" th:text="${i + 1}"></a>
                    </li>

                    <!-- Nút Next -->
                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link" th:if="${trangThai == null && khachHangId == null}"
                           th:href="@{/lichsumuahang(page=${currentPage + 1})}">&raquo;</a>
                        <a class="page-link" th:if="${trangThai != null}"
                           th:href="@{'/lichsumuahang/trangthai/' + ${trangThai}(page=${currentPage + 1})}">&raquo;</a>
                        <a class="page-link" th:if="${khachHangId != null}"
                           th:href="@{'/lichsumuahang/khachhang/' + ${khachHangId}(page=${currentPage + 1})}">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
    <!-- Modal Chi tiết đơn hàng -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="modalContent">
                <!-- Nội dung modal sẽ được load bằng AJAX -->
            </div>
        </div>
    </div>
</div>
</body>
<th:block layout:fragment="bottom_link">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/client/cart.js"></script>
    <script src="/js/client/iphone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        $(document).ready(function() {
            // Xử lý khi nhấn nút xem chi tiết
            $(document).on('click', '.btn-view-details', function() {
                var orderId = $(this).data('id');

                // Load nội dung modal bằng AJAX
                $('#modalContent').load('/lichsumuahang/modal/' + orderId, function() {
                    $('#orderDetailsModal').modal('show');
                });
            });
            $('.pagination .page-link').on('click', function() {
                if ($(this).parent().hasClass('disabled')) {
                    return false;
                }
            });
        });
        // // Hàm hủy đơn hàng
        // function cancelOrder(orderId) {
        //     if (confirm('Bạn có chắc chắn muốn hủy đơn hàng này?')) {
        //         $.ajax({
        //             url: '/lichsumuahang/huy/' + orderId,
        //             type: 'POST',
        //             success: function(response) {
        //                 alert('Đơn hàng đã được hủy thành công!');
        //                 // Reload trang sau khi hủy đơn hàng thành công
        //                 location.reload();
        //             },
        //             error: function(error) {
        //                 alert('Có lỗi xảy ra khi hủy đơn hàng. Vui lòng thử lại sau.');
        //             }
        //         });
        //     }
        // }
    </script>
</th:block>
</html>
