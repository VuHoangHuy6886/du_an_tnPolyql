<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="/admin/layout-dashboard/layout.html"
>
<head>
    <th:block layout:fragment="head_link">
        <style>
            /* Style cho bộ lọc */
            .filter-container {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                background-color: #f8f9fa;
                border-radius: 8px;
                padding: 15px;
                margin-top: 10px;
                margin-bottom: 15px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                align-items: center;
            }
            .filter-group {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                flex: 1;
                min-width: 300px;
                align-items: center;
            }
            .filter-buttons {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-bottom: 15px;
            }
            .filter-button {
                background-color: white;
                border: 1px solid #dee2e6;
                border-radius: 5px;
                padding: 8px 15px;
                cursor: pointer;
                transition: all 0.2s;
            }
            .filter-button:hover {
                border-color: #6c757d;
            }
            .filter-button.active {
                background-color: #718096;
                color: white;
                border-color: #718096;
            }
            .filter-label {
                font-weight: 500;
                white-space: nowrap;
            }
            .filter-input {
                flex: 1;
                min-width: 120px;
                padding: 6px 10px;
                border: 1px solid #ced4da;
                border-radius: 5px;
            }
            .search-button {
                background-color: #4B5563;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 6px 15px;
                cursor: pointer;
                white-space: nowrap;
            }
            .search-button:hover {
                background-color: #374151;
            }
            .search-group {
                display: flex;
                flex: 2;
                min-width: 250px;
                gap: 10px;
            }
            .price-group, .date-group {
                display: flex;
                gap: 10px;
                align-items: center;
                flex-wrap: wrap;
            }
            .display-select {
                width: 120px;
            }

            /* Style cho table */
            .table-container {
                margin-top: 15px;
                overflow-x: auto;
            }
            .table {
                width: 100%;
                font-size: 15px;
                border-collapse: collapse;
            }
            .table th {
                background-color: #4B5563;
                color: white;
                padding: 12px 15px;
                text-align: left;
            }
            .table td {
                padding: 12px 15px;
                border-bottom: 1px solid #e2e8f0;
            }
            .table tr:hover {
                background-color: #f8f9fa;
            }

            /* Style cho status badges */
            .status-badge {
                padding: 5px 10px;
                border-radius: 20px;
                font-size: 13px;
                font-weight: 500;
                color: white;
                display: inline-block;
            }
            .status-waiting {
                background-color: #FFA500;
            }
            .status-confirmed {
                background-color: #3498db;
            }
            .status-delivering {
                background-color: #9B59B6;
            }
            .status-completed {
                background-color: #2ECC71;
            }
            .status-cancelled {
                background-color: #E74C3C;
            }

            /* Style cho pagination */
            .pagination {
                display: flex;
                justify-content: center;
                margin-top: 20px;
            }
            .pagination .page-item {
                margin: 0 5px;
            }
            .pagination .page-link {
                border-radius: 5px;
                color: #4B5563;
                padding: 8px 12px;
            }
            .pagination .page-item.active .page-link {
                background-color: #4B5563;
                border-color: #4B5563;
            }

            /* Style cho buttons */
            .btn-view-details {
                background-color: #4B5563;
                color: white;
                border: none;
                border-radius: 5px;
                padding: 6px 12px;
                cursor: pointer;
            }
            .btn-view-details:hover {
                background-color: #374151;
            }

            /* Header style */
            .order-history-header {
                display: flex;
                align-items: center;
                margin-bottom: 15px;
            }
            .order-history-header h2 {
                margin-bottom: 0;
                margin-right: 20px;
            }
        </style>
    </th:block>
</head>

<div layout:fragment="content">
    <div class="container-fluid mt-4">
        <div class="order-history-header mb-4">
            <h2 class="text-primary fw-bold">
                <i class="fas fa-shopping-bag me-2" style="margin-left: 10px"></i>Danh sách hóa đơn
            </h2>
            <div class="title-underline"></div>
        </div>

        <!-- Bộ lọc trạng thái dạng button -->
        <div class="filter-buttons">
            <a href="/admin/hoa-don/index" class="filter-button">Tất cả</a>
            <a href="/admin/hoa-don/trangthai/Chờ xác nhận" class="filter-button">Chờ xác nhận</a>
            <a href="/admin/hoa-don/trangthai/Chờ đóng gói" class="filter-button">Chờ đóng gói</a>
            <a href="/admin/hoa-don/trangthai/Chờ giao hàng" class="filter-button">Chờ giao hàng</a>
            <a href="/admin/hoa-don/trangthai/Đang giao hàng" class="filter-button">Đang giao hàng</a>
            <a href="/admin/hoa-don/trangthai/Đã nhận hàng" class="filter-button">Đã nhận hàng</a>
            <a href="/admin/hoa-don/trangthai/Hoàn tất" class="filter-button">Hoàn tất</a>
            <a href="/admin/hoa-don/trangthai/Đã hủy" class="filter-button">Đã hủy</a>
        </div>

        <!-- Bộ lọc chi tiết -->
        <form th:action="@{/admin/hoa-don/search}" method="get" class="filter-container">
            <div class="filter-row">
                <div class="filter-label">Tìm kiếm:</div>
                <input type="text" class="filter-input" name="orderId" th:value="${orderId}" placeholder="Tìm kiếm mã đơn...">
            </div>
            <div class="filter-row">
                <div class="filter-label">Hiển thị:</div>
                <select class="filter-input" name="displayDays" onchange="this.form.submit()">
                    <option value="0" th:selected="${displayDays == null || displayDays == 0}">Tất cả</option>
                    <option value="7" th:selected="${displayDays == 7}">7 ngày</option>
                    <option value="30" th:selected="${displayDays == 30}">30 ngày</option>
                    <option value="60" th:selected="${displayDays == 60}">60 ngày</option>
                </select>
            </div>
            <div class="filter-row">
                <div class="filter-label">Từ:</div>
                <input type="number" class="filter-input" name="minAmount" th:value="${minAmount}" placeholder="0">
                <div class="filter-label">Đến:</div>
                <input type="number" class="filter-input" name="maxAmount" th:value="${maxAmount}" placeholder="5000000000">
            </div>
            <div class="filter-row">
                <div class="filter-label">Sau:</div>
                <input type="datetime-local" class="filter-input" name="fromDate" th:value="${fromDate}" placeholder="Từ ngày">
                <div class="filter-label">Trước:</div>
                <input type="datetime-local" class="filter-input" name="toDate" th:value="${toDate}" placeholder="Đến ngày">
            </div>
            <div class="filter-row">
                <button type="submit" class="search-button">Tìm kiếm</button>
                <a th:href="@{/admin/hoa-don/index}" class="search-button ml-2" style="text-decoration: none; text-align: center;">Reset</a>
            </div>
        </form>

        <!-- Danh sách đơn hàng - bảng đẹp hơn -->
        <div th:if="${hoaDons.isEmpty()}" class="alert alert-info">
            Không có đơn hàng nào.
        </div>

        <div th:if="${!hoaDons.isEmpty()}" class="table-container">
            <table class="table">
                <thead>
                <tr>
                    <th>Mã đơn</th>
                    <th>Ngày đặt</th>
                    <th>Người nhận</th>
                    <th>Số điện thoại</th>
                    <th>Địa chỉ</th>
                    <th>Tổng tiền</th>
                    <th>Thanh toán</th>
                    <th>Trạng thái</th>
                    <th>Thao tác</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="hoaDon : ${hoaDons}">
                    <td>#<span th:text="${hoaDon.id}"></span></td>
                    <td th:text="${#temporals.format(hoaDon.ngayNhanHang, 'dd/MM/yyyy')}"></td>
                    <td th:text="${hoaDon.tenNguoiNhan}"></td>
                    <td th:text="${hoaDon.soDienThoai}"></td>
                    <td th:text="${hoaDon.diaChi}" class="text-truncate" style="max-width: 150px;"></td>
                    <td th:text="${#numbers.formatDecimal(hoaDon.tongTien, 0, 'COMMA', 0, 'POINT')} + ' VND'"></td>
                    <td th:text="${hoaDon.phuongThucThanhToan}"></td>
                    <td>
                        <span class="status-badge" th:classappend="${
                            hoaDon.trangThai == 'Chờ xác nhận' ? 'status-waiting' : (
                            hoaDon.trangThai == 'Chờ đóng gói' || hoaDon.trangThai == 'Chờ giao hàng' ? 'status-confirmed' : (
                            hoaDon.trangThai == 'Đang giao hàng' ? 'status-delivering' : (
                            hoaDon.trangThai == 'Đã nhận hàng' || hoaDon.trangThai == 'Hoàn tất' ? 'status-completed' :
                            'status-cancelled')))}"
                              th:text="${hoaDon.trangThai}">
                        </span>
                    </td>
                    <td>
                        <button class="btn-view-details" th:data-id="${hoaDon.id}">
                            <i class="fas fa-eye me-1"></i>
                        </button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <!-- Phân trang - đã làm đẹp hơn -->
        <!-- Fix 1: Remove the duplicated pagination section and keep only one -->
        <div th:if="${totalPages > 1}" class="pagination-container">
            <nav aria-label="Phân trang">
                <ul class="pagination">
                    <!-- Nút Previous -->
                    <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
                        <a class="page-link" th:if="${trangThai == null && khachHangId == null}"
                           th:href="@{/admin/hoa-don/index(
                        page=${currentPage - 1},
                        orderId=${orderId},
                        minAmount=${minAmount},
                        maxAmount=${maxAmount},
                        fromDate=${fromDate},
                        toDate=${toDate},
                        displayDays=${displayDays})}">&laquo;</a>
                        <a class="page-link" th:if="${trangThai != null}"
                           th:href="@{'/admin/hoa-don/trangthai/' + ${trangThai}(
                        page=${currentPage - 1},
                        orderId=${orderId},
                        minAmount=${minAmount},
                        maxAmount=${maxAmount},
                        fromDate=${fromDate},
                        toDate=${toDate},
                        displayDays=${displayDays})}">&laquo;</a>
                        <a class="page-link" th:if="${khachHangId != null}"
                           th:href="@{'/admin/hoa-don/khachhang/' + ${khachHangId}(
                        page=${currentPage - 1},
                        orderId=${orderId},
                        minAmount=${minAmount},
                        maxAmount=${maxAmount},
                        fromDate=${fromDate},
                        toDate=${toDate},
                        displayDays=${displayDays})}">&laquo;</a>
                    </li>

                    <!-- Các nút số trang -->
                    <li class="page-item" th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                        th:classappend="${currentPage == i} ? 'active'">
                        <a class="page-link" th:if="${trangThai == null && khachHangId == null}"
                           th:href="@{/admin/hoa-don/index(
                        page=${i},
                        orderId=${orderId},
                        minAmount=${minAmount},
                        maxAmount=${maxAmount},
                        fromDate=${fromDate},
                        toDate=${toDate},
                        displayDays=${displayDays})}" th:text="${i + 1}"></a>
                        <a class="page-link" th:if="${trangThai != null}"
                           th:href="@{'/admin/hoa-don/trangthai/' + ${trangThai}(
                        page=${i},
                        orderId=${orderId},
                        minAmount=${minAmount},
                        maxAmount=${maxAmount},
                        fromDate=${fromDate},
                        toDate=${toDate},
                        displayDays=${displayDays})}" th:text="${i + 1}"></a>
                        <a class="page-link" th:if="${khachHangId != null}"
                           th:href="@{'/admin/hoa-don/khachhang/' + ${khachHangId}(
                        page=${i},
                        orderId=${orderId},
                        minAmount=${minAmount},
                        maxAmount=${maxAmount},
                        fromDate=${fromDate},
                        toDate=${toDate},
                        displayDays=${displayDays})}" th:text="${i + 1}"></a>
                    </li>

                    <!-- Nút Next -->
                    <li class="page-item" th:classappend="${currentPage == totalPages - 1} ? 'disabled'">
                        <a class="page-link" th:if="${trangThai == null && khachHangId == null}"
                           th:href="@{/admin/hoa-don/index(
                        page=${currentPage + 1},
                        orderId=${orderId},
                        minAmount=${minAmount},
                        maxAmount=${maxAmount},
                        fromDate=${fromDate},
                        toDate=${toDate},
                        displayDays=${displayDays})}">&raquo;</a>
                        <a class="page-link" th:if="${trangThai != null}"
                           th:href="@{'/admin/hoa-don/trangthai/' + ${trangThai}(
                        page=${currentPage + 1},
                        orderId=${orderId},
                        minAmount=${minAmount},
                        maxAmount=${maxAmount},
                        fromDate=${fromDate},
                        toDate=${toDate},
                        displayDays=${displayDays})}">&raquo;</a>
                        <a class="page-link" th:if="${khachHangId != null}"
                           th:href="@{'/admin/hoa-don/khachhang/' + ${khachHangId}(
                        page=${currentPage + 1},
                        orderId=${orderId},
                        minAmount=${minAmount},
                        maxAmount=${maxAmount},
                        fromDate=${fromDate},
                        toDate=${toDate},
                        displayDays=${displayDays})}">&raquo;</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- Modal Chi tiết đơn hàng - giữ nguyên -->
    <div class="modal fade" id="orderDetailsModal" tabindex="-1" aria-labelledby="orderDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" id="modalContent">
                <!-- Nội dung modal sẽ được load bằng AJAX -->
            </div>
        </div>
    </div>
</div>
</body>
<th:block layout:fragment="bottom_link">
    <script>
        $(document).ready(function() {
            // Xử lý khi nhấn nút xem chi tiết
            $(document).on('click', '.btn-view-details', function() {
                var orderId = $(this).data('id');

                // Load nội dung modal bằng AJAX
                $('#modalContent').load('/admin/hoa-don/modal/' + orderId, function() {
                    $('#orderDetailsModal').modal('show');
                });
            });

            // Xử lý khi nhấn nút lọc
            $('.filter-button').on('click', function() {
                $('.filter-button').removeClass('active');
                $(this).addClass('active');

                var status = $(this).text().trim();
                if (status === 'Tất cả') {
                    window.location.href = '/admin/hoa-don/index';
                } else {
                    window.location.href = '/admin/hoa-don/trangthai/' + status;
                }
            });
            // Xử lý nút phân trang
            $('.pagination .page-link').on('click', function() {
                if ($(this).parent().hasClass('disabled')) {
                    return false;
                }
            });

            // Hiển thị trạng thái active cho nút lọc hiện tại
            var currentStatus = window.location.pathname.split('/').pop();
            $('.filter-button').each(function() {
                var buttonText = $(this).text().trim();
                if ((currentStatus === 'index' && buttonText === 'Tất cả') ||
                    buttonText === decodeURIComponent(currentStatus)) {
                    $(this).addClass('active');
                }
            });

            // Xử lý hiển thị lọc ngày
            $('select[name="displayDays"]').on('change', function() {
                if ($(this).val() !== "") {
                    // Reset các trường tìm kiếm khác
                    $('input[name="orderId"]').val('');
                    $('input[name="minAmount"]').val('');
                    $('input[name="maxAmount"]').val('');
                    $('input[name="fromDate"]').val('');
                    $('input[name="toDate"]').val('');

                    // Submit form
                    $(this).closest('form').submit();
                }
            });

// Format tiền tệ cho input
            $('input[name="minAmount"], input[name="maxAmount"]').on('input', function() {
                // Chỉ cho phép nhập số
                this.value = this.value.replace(/[^0-9]/g, '');
            });

// Kiểm tra form trước khi submit
            $('.filter-container').on('submit', function(e) {
                var minAmount = $('input[name="minAmount"]').val();
                var maxAmount = $('input[name="maxAmount"]').val();

                if (minAmount && maxAmount && parseInt(minAmount) > parseInt(maxAmount)) {
                    alert('Giá trị "Từ" không thể lớn hơn giá trị "Đến"');
                    e.preventDefault();
                    return false;
                }

                var fromDate = $('input[name="fromDate"]').val();
                var toDate = $('input[name="toDate"]').val();

                if (fromDate && toDate && new Date(fromDate) > new Date(toDate)) {
                    alert('Ngày "Sau" không thể muộn hơn ngày "Trước"');
                    e.preventDefault();
                    return false;
                }
            });
        });
    </script>
</th:block>
</html>